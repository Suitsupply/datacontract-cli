{# filepath: datasource_yml.jinja #}
{# This template generates YAML configuration for dbt data sources based on contract specifications #}
version: 2
sources:
  - name: {{ contract.dataset }}
    project: {{ contract.project }}
    loader: {{ contract.loader }}
    tables:
      - name: {{ contract.product }}__{{ contract.entity }}
        identifier: {{ contract.identifier }}
        {% if contract.config_meta %}
        meta: {{ contract.config_meta }}
        {% endif %}
        {% if contract.config_tags %}
        tags: {{ contract.config_tags }}
        {% endif %}
        {% if contract.config_labels %}
        labels: {{ contract.config_labels }}
        {% endif %}
        {% if contract.recency_threshold > 0 %}
        freshness:
          warn_after:
            count: {{ contract.recency_threshold }}
            period: day
        {% else %}
        freshness: null
        {% endif %}
        loaded_at_field: |-
          (
            SELECT 
              GREATEST(
                MAX({{ contract.recency_validation }}),
                MAX(COALESCE(PARSE_TIMESTAMP('%Y-%m-%d', review_data.reviewed_at), TIMESTAMP('1970-01-01')))
              ) as loaded_at
            FROM `{{ contract.project }}.{{ contract.dataset }}.{{ contract.identifier }}` as source_data
            LEFT JOIN `{{ contract.project }}.elementary.dbt_source_freshness_reviews` as review_data
              ON review_data.table_id = '{{ contract.dataset }}.{{ contract.identifier }}'
          )
